<%- include('partials/header') %>

<main class="container mt-5">
  <h2>Welcome to the Event Management Platform</h2>

  <!-- Button to trigger the Add Event Modal -->
  <div class="mb-4">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEventModal">
      Add New Event
    </button>
  </div>

  <!-- Upcoming Events List -->
  <div class="mt-4">
    <h3>Upcoming Events</h3>
    <ul class="list-group">
      <% events.forEach(event => { %>
        <li class="list-group-item">
          <h5><%= event.name %></h5>
          <p><%= event.description %></p>
          <p><strong>Date:</strong> <%= event.date %></p>
          <a href="/events/<%= event.id %>" class="btn btn-primary">View Details</a>
        </li>
      <% }) %>
    </ul>
  </div>
</main>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEventModalLabel">Add New Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Add Event Form -->
        <form id="addEventForm">
          <div class="mb-3">
            <label for="name" class="form-label">Event Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" required></textarea>
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date" required>
          </div>
          <div class="mb-3">
            <label for="organizer" class="form-label">Organizer</label>
            <input type="text" class="form-control" id="organizer" name="organizer" required>
          </div>
          <div class="mb-3">
            <label for="venue" class="form-label">Venue</label>
            <input type="text" class="form-control" id="venue" name="venue" required>
          </div>
          <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input type="text" class="form-control" id="city" name="city" required>
          </div>
          <div class="mb-3">
            <label for="state" class="form-label">State</label>
            <input type="text" class="form-control" id="state" name="state" required>
          </div>
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input type="text" class="form-control" id="country" name="country" required>
          </div>
          <div class="mb-3">
            <label for="categories" class="form-label">Categories (comma-separated)</label>
            <input type="text" class="form-control" id="categories" name="categories" required>
          </div>
          <div class="mb-3">
            <label for="speakers" class="form-label">Speakers (name:topic, comma-separated)</label>
            <input type="text" class="form-control" id="speakers" name="speakers" required>
          </div>
          <div class="mb-3">
            <label for="sponsors" class="form-label">Sponsors (comma-separated)</label>
            <input type="text" class="form-control" id="sponsors" name="sponsors" required>
          </div>
          <div class="mb-3">
            <label for="schedule" class="form-label">Schedule (time:activity, comma-separated)</label>
            <input type="text" class="form-control" id="schedule" name="schedule" required>
          </div>
          <button type="submit" class="btn btn-primary">Save Event</button>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
<script>
  document.getElementById('addEventForm').addEventListener('submit', async function(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const formProps = Object.fromEntries(formData);
  
  formProps.categories = formProps.categories.split(',').map(cat => cat.trim());
  formProps.speakers = formProps.speakers.split(',').map(sp => {
    const [name, topic] = sp.split(':');
    return { name: name.trim(), topic: topic.trim() };
  });
  formProps.sponsors = formProps.sponsors.split(',').map(sp => sp.trim());
  formProps.schedule = formProps.schedule.split(',').map(sch => {
    const [time, activity] = sch.split(':');
    return { time: time.trim(), activity: activity.trim() };
  });
  
  formProps.location = {
    venue: formProps.venue,
    city: formProps.city,
    state: formProps.state,
    country: formProps.country,
  };
  
  delete formProps.venue;
  delete formProps.city;
  delete formProps.state;
  delete formProps.country;

  const token = localStorage.getItem('token'); // Retrieve the token from localStorage or wherever it's stored

  const response = await fetch('/api/events/create', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}` // Include the token in the Authorization header
    },
    body: JSON.stringify(formProps)
  });
  
  if (response.ok) {
    location.reload(); // Refresh the page to show the new event
  } else {
    alert('Failed to save the event');
  }
});
</script>
